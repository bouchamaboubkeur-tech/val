<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíù Be My Valentine? üíù</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-rose: #ff4d6d;
            --secondary-rose: #ff758f;
            --accent-gold: #ffd700;
            --deep-purple: #432371;
            --soft-pink: #ffccd5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            cursor: none !important;
        }

        body {
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            background: #0f0c29;
            background: linear-gradient(to right, #24243e, #302b63, #0f0c29);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            margin: 0;
            padding: 0;
        }

        /* WebGL Flower Canvas */
        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
            z-index: 1;
        }

        .drawing-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10002;
            display: flex;
            gap: 10px;
            flex-direction: column;
        }

        .drawing-btn {
            background: rgba(255, 77, 109, 0.9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 77, 109, 0.4);
            pointer-events: auto;
        }

        .drawing-btn:hover {
            background: rgba(245, 87, 108, 1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 77, 109, 0.6);
        }

        .drawing-instruction {
            background: rgba(255, 77, 109, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(255, 77, 109, 0.4);
        }

        /* Custom Flower Cursor */
        .cursor-flower {
            position: fixed;
            width: 40px;
            height: 40px;
            pointer-events: none;
            z-index: 100000;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease;
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(0 0 8px rgba(255, 117, 143, 0.6));
        }

        .cursor-flower.clicking {
            transform: translate(-50%, -50%) scale(1.3);
        }

        .cursor-light {
            position: fixed;
            width: 80px;
            height: 80px;
            pointer-events: none;
            z-index: 99999;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(255, 117, 143, 0.4) 0%, rgba(255, 77, 109, 0.2) 30%, transparent 70%);
            border-radius: 50%;
            animation: lightPulse 1.5s ease-in-out infinite;
            filter: blur(10px);
        }

        @keyframes lightPulse {
            0%, 100% { 
                opacity: 0.6;
                transform: translate(-50%, -50%) scale(1);
            }
            50% { 
                opacity: 0.9;
                transform: translate(-50%, -50%) scale(1.2);
            }
        }

        .trail-particle {
            position: fixed;
            width: 6px;
            height: 6px;
            background: radial-gradient(circle, #ffd700, #ff758f);
            border-radius: 50%;
            pointer-events: none;
            z-index: 99998;
            animation: trailFade 0.8s ease-out forwards;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }

        @keyframes trailFade {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.3);
            }
        }

        body::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 50%, rgba(255, 77, 109, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 40% 20%, rgba(245, 87, 108, 0.15) 0%, transparent 50%);
            animation: gradientShift 15s ease infinite;
            pointer-events: none;
        }

        @keyframes gradientShift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(-50px, 50px) rotate(120deg); }
            66% { transform: translate(50px, -50px) rotate(240deg); }
        }

        .particle {
            position: absolute;
            pointer-events: none;
            opacity: 0.6;
        }

        .particle-heart {
            width: 20px;
            height: 20px;
            animation: particleFloat 8s infinite;
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-100px) translateX(var(--drift)) rotate(720deg) scale(1);
                opacity: 0;
            }
        }

        .container {
            text-align: center;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 60px 50px;
            border-radius: 30px;
            border: 2px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37),
                        inset 0 0 80px rgba(255, 255, 255, 0.05);
            max-width: 550px;
            width: 90%;
            min-height: 500px;
            position: relative;
            z-index: 10;
            animation: containerEntrance 1.2s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            pointer-events: auto;
        }

        @keyframes containerEntrance {
            0% {
                opacity: 0;
                transform: translateY(100px) scale(0.8);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .heart-illustration {
            width: 150px;
            height: 150px;
            margin: 0 auto 25px;
            filter: drop-shadow(0 10px 30px rgba(255, 77, 109, 0.4));
            animation: heartBeat 1.5s ease-in-out infinite;
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            10% { transform: scale(1.1); }
            20% { transform: scale(1); }
            30% { transform: scale(1.15); }
            40% { transform: scale(1); }
        }

        .heart-illustration svg {
            width: 100%;
            height: 100%;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            background: linear-gradient(135deg, #fff 0%, #ffccd5 50%, #ff758f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 3em;
            margin: 15px 0;
            font-weight: 900;
            letter-spacing: 2px;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            animation: titleShimmer 3s ease-in-out infinite;
            line-height: 1.2;
        }

        @keyframes titleShimmer {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .subtitle {
            font-size: 1em;
            color: rgba(255, 255, 255, 0.7);
            margin: 10px 0 25px;
            font-weight: 300;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .question {
            font-size: 1.4em;
            color: #fff;
            margin: 25px 0 40px;
            font-weight: 400;
            line-height: 1.6;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .buttons-wrapper {
            position: relative;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
            width: 100%;
        }

        .buttons {
            display: flex;
            gap: 25px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
        }

        button {
            padding: 18px 45px;
            font-size: 1.2em;
            font-family: 'Poppins', sans-serif;
            border: none;
            border-radius: 50px;
            cursor: none;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        #yesBtn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            box-shadow: 0 10px 40px rgba(245, 87, 108, 0.4),
                        0 0 20px rgba(255, 255, 255, 0.1) inset;
            animation: yesGlow 2s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }

        @keyframes yesGlow {
            0%, 100% { 
                box-shadow: 0 10px 40px rgba(245, 87, 108, 0.4),
                            0 0 20px rgba(255, 255, 255, 0.1) inset;
            }
            50% { 
                box-shadow: 0 10px 60px rgba(245, 87, 108, 0.8),
                            0 0 30px rgba(255, 255, 255, 0.2) inset;
            }
        }

        #yesBtn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 50px rgba(245, 87, 108, 0.6),
                        0 0 30px rgba(255, 255, 255, 0.2) inset;
        }

        #noBtn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 10px 40px rgba(118, 75, 162, 0.3),
                        0 0 20px rgba(255, 255, 255, 0.1) inset;
            position: relative;
            transition: all 0.3s ease;
        }

        #noBtn:hover {
            transform: translateY(-3px);
        }

        .success {
            display: none;
            animation: successEntrance 1s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes successEntrance {
            0% {
                opacity: 0;
                transform: scale(0.3) rotateY(180deg);
            }
            60% {
                transform: scale(1.1) rotateY(-10deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotateY(0);
            }
        }

        .success h2 {
            font-family: 'Playfair Display', serif;
            background: linear-gradient(135deg, #fff 0%, #ffd700 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 3em;
            margin: 25px 0;
            font-weight: 900;
            animation: successGlow 2s ease-in-out infinite;
            line-height: 1.2;
        }

        @keyframes successGlow {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5)); }
            50% { filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.8)); }
        }

        .success-emoji {
            font-size: 100px;
            display: inline-block;
            animation: celebrationSpin 3s ease-in-out infinite;
            filter: drop-shadow(0 10px 30px rgba(255, 215, 0, 0.5));
        }

        @keyframes celebrationSpin {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-15deg) scale(1.1); }
            75% { transform: rotate(15deg) scale(1.1); }
        }

        .success-message {
            font-size: 1.2em;
            color: rgba(255, 255, 255, 0.9);
            margin: 20px 0;
            line-height: 1.8;
        }

        .petal {
            position: absolute;
            width: 15px;
            height: 15px;
            background: radial-gradient(ellipse at center, #ffccd5 0%, #ff758f 100%);
            border-radius: 50% 0 50% 0;
            pointer-events: none;
            animation: petalFall 6s linear infinite;
            opacity: 0.8;
        }

        @keyframes petalFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .envelope-container {
            position: fixed;
            bottom: 30px;
            right: -150px;
            z-index: 100;
            cursor: none;
            transition: right 1.5s ease-in-out;
            pointer-events: none;
        }

        .envelope-container.peeking {
            animation: envelopePeek 4s ease-in-out infinite;
        }

        @keyframes envelopePeek {
            0%, 100% { right: -150px; }
            40%, 60% { right: 30px; }
        }

        .envelope-container.visible {
            right: 30px;
            pointer-events: auto;
            animation: none;
        }

        .envelope-container.fade-out {
            opacity: 0;
            right: -150px;
        }

        .envelope {
            width: 120px;
            height: 80px;
            position: relative;
            animation: envelopeBounce 3s ease-in-out infinite;
        }

        @keyframes envelopeBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .envelope-body {
            width: 120px;
            height: 80px;
            background: linear-gradient(135deg, #fff 0%, #ffccd5 100%);
            border-radius: 5px;
            position: relative;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 2px solid #ff758f;
        }

        .envelope-flap {
            width: 0;
            height: 0;
            border-left: 60px solid transparent;
            border-right: 60px solid transparent;
            border-top: 50px solid #ff4d6d;
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: top center;
            transition: transform 0.6s ease;
            z-index: 2;
        }

        .envelope.open .envelope-flap {
            transform: rotateX(180deg);
        }

        .envelope-hearts {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            z-index: 1;
        }

        .envelope-label {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 77, 109, 0.9);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(255, 77, 109, 0.4);
            animation: labelPulse 2s ease-in-out infinite;
        }

        @keyframes labelPulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }

        .letter-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50000;
            animation: modalFadeIn 0.3s ease;
        }

        .letter-modal.show {
            display: flex;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .letter {
            background: linear-gradient(135deg, #fff 0%, #fffaf0 100%);
            padding: 50px 40px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
            animation: letterSlideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            border: 3px solid #ff758f;
        }

        @keyframes letterSlideIn {
            from {
                opacity: 0;
                transform: translateY(100px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .letter-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 35px;
            height: 35px;
            background: #ff4d6d;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(255, 77, 109, 0.4);
        }

        .letter-close:hover {
            background: #f5576c;
            transform: scale(1.1);
        }

        .letter-header {
            font-family: 'Playfair Display', serif;
            font-size: 2em;
            color: #ff4d6d;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 700;
        }

        .letter-content {
            font-size: 1.1em;
            line-height: 1.8;
            color: #333;
            margin-bottom: 20px;
            font-family: 'Poppins', sans-serif;
        }

        .letter-signature {
            text-align: right;
            font-family: 'Playfair Display', serif;
            font-size: 1.3em;
            color: #ff4d6d;
            margin-top: 30px;
            font-style: italic;
        }

        .letter-decoration {
            text-align: center;
            font-size: 2em;
            margin: 20px 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .drawing-controls {
                top: 15px;
                left: 15px;
            }

            .drawing-btn, .drawing-instruction {
                padding: 8px 16px;
                font-size: 12px;
            }

            .container {
                padding: 50px 35px;
                max-width: 90%;
                min-height: 450px;
            }
            h1 { font-size: 2.2em; }
            .question { font-size: 1.2em; }
            button { padding: 15px 35px; font-size: 1.1em; }
            .cursor-flower { width: 30px; height: 30px; font-size: 24px; }
            .cursor-light { width: 60px; height: 60px; }
        }

        @media (max-width: 480px) {
            .container {
                padding: 40px 25px;
                width: 95%;
            }
            h1 { font-size: 1.8em; }
            .question { font-size: 1.1em; }
            button { padding: 12px 28px; font-size: 1em; }
        }
    </style>
</head>
<body>
    <!-- WebGL Flower Canvas -->
    <canvas id="canvas"></canvas>

    <!-- Drawing Controls -->
    <div class="drawing-controls">
        <div class="drawing-instruction">üå∏ Click anywhere to see yourself!</div>
        <button class="drawing-btn" id="clearCanvas">üóëÔ∏è</button>
    </div>

    <!-- Custom Cursor Elements -->
    <div class="cursor-light" id="cursorLight"></div>
    <div class="cursor-flower" id="cursorFlower">üå∏</div>

    <!-- Envelope -->
    <div class="envelope-container" id="envelopeContainer">
        <div class="envelope" id="envelope" onclick="openEnvelope()">
            <div class="envelope-flap"></div>
            <div class="envelope-body">
                <div class="envelope-hearts">üíå</div>
            </div>
            <div class="envelope-label" id="envelopeLabel">Click me! üíï</div>
        </div>
    </div>

    <!-- Letter Modal -->
    <div class="letter-modal" id="letterModal" onclick="closeLetterModal(event)">
        <div class="letter" id="letterContent" onclick="event.stopPropagation()">
            <button class="letter-close" onclick="closeLetterModal(event)">‚úï</button>
            <div id="letterText"></div>
        </div>
    </div>

    <div class="container" id="mainContainer">
        <div id="questionSection">
            <div class="heart-illustration">
                <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="heartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ff4d6d;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#ff758f;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#ffccd5;stop-opacity:1" />
                        </linearGradient>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    <path d="M100,170 C100,170 30,120 30,80 C30,50 50,30 75,30 C85,30 95,35 100,45 C105,35 115,30 125,30 C150,30 170,50 170,80 C170,120 100,170 100,170 Z" 
                          fill="url(#heartGradient)" 
                          filter="url(#glow)"
                          stroke="#fff" 
                          stroke-width="2"/>
                    <circle cx="85" cy="65" r="8" fill="#fff" opacity="0.8">
                        <animate attributeName="opacity" values="0.8;0.3;0.8" dur="2s" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="115" cy="75" r="5" fill="#fff" opacity="0.6">
                        <animate attributeName="opacity" values="0.6;0.2;0.6" dur="2.5s" repeatCount="indefinite"/>
                    </circle>
                </svg>
            </div>

            <h1>A Special Question</h1>
            <p class="subtitle">For Someone Special</p>
            <p class="question">Would you do me the honor of being my Valentine? ‚ú®</p>
            
            <div class="buttons-wrapper">
                <div class="buttons">
                    <button id="yesBtn" onclick="sayYes()">Yes! üíï</button>
                    <button id="noBtn" onmouseover="runAway()" ontouchstart="runAway()" onclick="runAway()">No</button>
                </div>
            </div>
        </div>

        <div class="success" id="successSection">
            <div class="success-emoji">üéä</div>
            <h2>You Made My Day!</h2>
            <p class="success-message">I'm absolutely thrilled! This is the best day ever! üíñ</p>
            <div class="success-emoji">üåπ</div>
        </div>
    </div>

    <!-- WebGL Shaders -->
    <script type="x-shader/x-fragment" id="fragmentShader">
        #define PI 3.14159265359

        uniform float u_ratio;
        uniform vec2 u_cursor;
        uniform float u_stop_time;
        uniform float u_clean;
        uniform vec2 u_stop_randomizer;

        uniform sampler2D u_texture;
        varying vec2 vUv;

        vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
        vec2 mod289(vec2 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
        vec3 permute(vec3 x) { return mod289(((x*34.0)+1.0)*x); }
        float snoise(vec2 v) {
            const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);
            vec2 i = floor(v + dot(v, C.yy));
            vec2 x0 = v - i + dot(i, C.xx);
            vec2 i1;
            i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
            vec4 x12 = x0.xyxy + C.xxzz;
            x12.xy -= i1;
            i = mod289(i);
            vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));
            vec3 m = max(0.5 - vec3(dot(x0, x0), dot(x12.xy, x12.xy), dot(x12.zw, x12.zw)), 0.0);
            m = m*m;
            m = m*m;
            vec3 x = 2.0 * fract(p * C.www) - 1.0;
            vec3 h = abs(x) - 0.5;
            vec3 ox = floor(x + 0.5);
            vec3 a0 = x - ox;
            m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);
            vec3 g;
            g.x = a0.x * x0.x + h.x * x0.y;
            g.yz = a0.yz * x12.xz + h.yz * x12.yw;
            return 130.0 * dot(m, g);
        }

        float get_flower_shape(vec2 _p, float _pet_n, float _angle, float _outline) {
            _angle *= 3.;

            _p = vec2(_p.x * cos(_angle) - _p.y * sin(_angle),
            _p.x * sin(_angle) + _p.y * cos(_angle));

            float a = atan(_p.y, _p.x);

            float flower_sectoral_shape = pow(abs(sin(a * _pet_n)), .4) + .25;

            vec2 flower_size_range = vec2(.02, .06);
            float size = flower_size_range[0] + u_stop_randomizer[0] * flower_size_range[1];

            float flower_radial_shape = pow(length(_p) / size, 2.);
            flower_radial_shape -= .1 * sin(8. * a);
            flower_radial_shape = max(.1, flower_radial_shape);
            flower_radial_shape += smoothstep(0., 0.03, -_p.y + .2 * abs(_p.x));

            float grow_time = step(.25, u_stop_time) * pow(u_stop_time, .3);
            float flower_shape = 1. - smoothstep(0., flower_sectoral_shape, _outline * flower_radial_shape / grow_time);

            flower_shape *= (1. - step(1., grow_time));

            return flower_shape;
        }

        float get_stem_shape(vec2 _p, vec2 _uv, float _w, float _angle) {
            _w = max(.004, _w);
            
            float x_offset = _p.y * sin(_angle);
            x_offset *= pow(3. * _uv.y, 2.);
            _p.x -= x_offset;

            float noise_power = .5;
            float cursor_horizontal_noise = noise_power * snoise(2. * _uv * u_stop_randomizer[0]);
            cursor_horizontal_noise *= pow(dot(_p.y, _p.y), .6);
            cursor_horizontal_noise *= pow(dot(_uv.y, _uv.y), .3);
            _p.x += cursor_horizontal_noise;

            float left = smoothstep(-_w, 0., _p.x);
            float right = 1. - smoothstep(0., _w, _p.x);
            float stem_shape = left * right;

            float grow_time = 1. - smoothstep(0., .2, u_stop_time);
            float stem_top_mask = smoothstep(0., pow(grow_time, .5), .03 -_p.y);
            stem_shape *= stem_top_mask;

            stem_shape *= (1. - step(.17, u_stop_time));

            return stem_shape;
        }

        void main() {
            vec3 base = texture2D(u_texture, vUv).xyz;

            vec2 uv = vUv;
            uv.x *= u_ratio;
            vec2 cursor = vUv - u_cursor.xy;
            cursor.x *= u_ratio;
            
            vec3 stem_color = vec3(.1 + u_stop_randomizer[0] * .6, .6, .2);
            vec3 flower_color = vec3(.6 + .5 * u_stop_randomizer[1], .1, .9 - .5 * u_stop_randomizer[1]);

            float angle = .5 * (u_stop_randomizer[0] - .5);

            float stem_shape = get_stem_shape(cursor, uv, .003, angle);
            stem_shape += get_stem_shape(cursor + vec2(0., .2 + .5 * u_stop_randomizer[0]), uv, .003, angle);
            float stem_mask = 1. - get_stem_shape(cursor, uv, .004, angle);
            stem_mask -= get_stem_shape(cursor + vec2(0., .2 + .5 * u_stop_randomizer[0]), uv, .004, angle);

            float petals_back_number = 1. + floor(u_stop_randomizer[0] * 2.);
            float angle_offset = -(2. * step(0., angle) - 1.) * .1 * u_stop_time;
            float flower_back_shape = get_flower_shape(cursor, petals_back_number, angle + angle_offset, 1.5);
            float flower_back_mask = 1. - get_flower_shape(cursor, petals_back_number, angle + angle_offset, 1.6);

            float petals_front_number = 2. + floor(u_stop_randomizer[1] * 2.);
            float flower_front_shape = get_flower_shape(cursor, petals_front_number, angle, 1.);
            float flower_front_mask = 1. - get_flower_shape(cursor, petals_front_number, angle, .95);

            vec3 color = base;
            color *= stem_mask;
            color *= flower_back_mask;
            color *= flower_front_mask;

            color += (stem_shape * stem_color);

            color += (flower_back_shape * (flower_color + vec3(0., .8 * u_stop_time, 0.)));
            color += (flower_front_shape * flower_color);

            color.r *= 1. - (.5 * flower_back_shape * flower_front_shape);
            color.b *= 1. - (flower_back_shape * flower_front_shape);

            color *= u_clean;

            gl_FragColor = vec4(color, 1.);
        }
    </script>

    <script type="x-shader/x-vertex" id="vertexShader">
        varying vec2 vUv;
        void main() {
            vUv = uv;
            gl_Position = vec4(position, 1.);
        }
    </script>

    <script type="module">
        import * as THREE from "https://cdn.skypack.dev/three@0.133.1/build/three.module";

        // WebGL Flower Drawing Setup
        const canvasEl = document.getElementById('canvas');
        const cleanBtn = document.getElementById('clearCanvas');
        
        const pointer = {
            x: 0.5,
            y: 0.5,
            clicked: false,
            vanishCanvas: false
        };

        let basicMaterial, shaderMaterial;
        let renderer = new THREE.WebGLRenderer({
            canvas: canvasEl,
            alpha: true,
        });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

        let sceneShader = new THREE.Scene();
        let sceneBasic = new THREE.Scene();
        let camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 10);
        let clock = new THREE.Clock();
        let renderTargets = [
            new THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight),
            new THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight)
        ];

        createPlane();
        updateSize();
        window.addEventListener("resize", () => {
            updateSize();
        });
        render();

        let isTouchScreen = false;
        window.addEventListener("click", e => {
            if (!isTouchScreen) {
                pointer.x = e.pageX / window.innerWidth;
                pointer.y = e.pageY / window.innerHeight;
                pointer.clicked = true;
            }
        });
        
        window.addEventListener("touchstart", e => {
            isTouchScreen = true;
            pointer.x = e.targetTouches[0].pageX / window.innerWidth;
            pointer.y = e.targetTouches[0].pageY / window.innerHeight;
            pointer.clicked = true;
        });

        cleanBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            cleanCanvas();
        });

        function cleanCanvas() {
            pointer.vanishCanvas = true;
            setTimeout(() => {
                pointer.vanishCanvas = false;
            }, 50);
        }

        function createPlane() {
            shaderMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    u_stop_time: {type: "f", value: 0.},
                    u_stop_randomizer: {type: "v2", value: new THREE.Vector2(Math.random(), Math.random())},
                    u_cursor: {type: "v2", value: new THREE.Vector2(pointer.x, pointer.y)},
                    u_ratio: {type: "f", value: window.innerWidth / window.innerHeight},
                    u_texture: {type: "t", value: null},
                    u_clean: {type: "f", value: 1.},
                },
                vertexShader: document.getElementById("vertexShader").textContent,
                fragmentShader: document.getElementById("fragmentShader").textContent
            });
            basicMaterial = new THREE.MeshBasicMaterial();
            const planeGeometry = new THREE.PlaneGeometry(2, 2);
            const planeBasic = new THREE.Mesh(planeGeometry, basicMaterial);
            const planeShader = new THREE.Mesh(planeGeometry, shaderMaterial);
            sceneBasic.add(planeBasic);
            sceneShader.add(planeShader);
        }

        function render() {
            shaderMaterial.uniforms.u_clean.value = pointer.vanishCanvas ? 0 : 1;
            shaderMaterial.uniforms.u_texture.value = renderTargets[0].texture;
            if (pointer.clicked) {
                shaderMaterial.uniforms.u_cursor.value = new THREE.Vector2(pointer.x, 1 - pointer.y);
                shaderMaterial.uniforms.u_stop_randomizer.value = new THREE.Vector2(Math.random(), Math.random());
                shaderMaterial.uniforms.u_stop_time.value = 0.;
                pointer.clicked = false;
            }
            shaderMaterial.uniforms.u_stop_time.value += clock.getDelta();
            renderer.setRenderTarget(renderTargets[1]);
            renderer.render(sceneShader, camera);
            basicMaterial.map = renderTargets[1].texture;
            renderer.setRenderTarget(null);
            renderer.render(sceneBasic, camera);
            let tmp = renderTargets[0];
            renderTargets[0] = renderTargets[1];
            renderTargets[1] = tmp;
            requestAnimationFrame(render);
        }

        function updateSize() {
            shaderMaterial.uniforms.u_ratio.value = window.innerWidth / window.innerHeight;
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Letter content
        const letters = [
            {
                header: "Why You're Special ‚ú®",
                content: "From the moment I met you, I knew there was something extraordinary about you. Your smile lights up my darkest days, and your laughter is the most beautiful melody I've ever heard. You have this incredible way of making everything better just by being yourself.",
                signature: "With all my heart üíï"
            },
            {
                header: "My Favorite Moments üåü",
                content: "Every moment we spend together becomes a treasured memory. Whether we're sharing inside jokes, having deep conversations, or simply enjoying comfortable silence, each second with you is precious. You make ordinary moments feel magical, and I cherish every single one.",
                signature: "Forever grateful üåπ"
            },
            {
                header: "What You Mean to Me üíñ",
                content: "You are my sunshine on cloudy days, my inspiration when I need motivation, and my comfort when life gets tough. Your kindness, your strength, and your beautiful soul never cease to amaze me. Being with you feels like coming home. And I finally found the word I was always talking about ‚Äî you are my apricity, the warm sun on my coldest days (yes, I actually found it this time üòÑ). You're not just special ‚Äî you're everything.",
                signature: "Always yours üíù"
            }
        ];

        let currentLetterIndex = 0;

        window.addEventListener('load', function() {
            const envelopeContainer = document.getElementById('envelopeContainer');
            envelopeContainer.classList.add('peeking');
        });

        window.openEnvelope = function() {
            if (currentLetterIndex >= letters.length) {
                return;
            }

            const envelope = document.getElementById('envelope');
            const letterModal = document.getElementById('letterModal');
            const letterText = document.getElementById('letterText');
            const envelopeLabel = document.getElementById('envelopeLabel');
            
            envelope.classList.add('open');
            
            setTimeout(() => {
                const letter = letters[currentLetterIndex];
                letterText.innerHTML = `
                    <div class="letter-header">${letter.header}</div>
                    <div class="letter-decoration">‚úø ‚ùÄ ‚úø</div>
                    <div class="letter-content">${letter.content}</div>
                    <div class="letter-signature">${letter.signature}</div>
                    <div class="letter-decoration">üíï</div>
                `;
                
                letterModal.classList.add('show');
                currentLetterIndex++;
                
                if (currentLetterIndex < letters.length) {
                    envelopeLabel.textContent = `${letters.length - currentLetterIndex} more letter${letters.length - currentLetterIndex > 1 ? 's' : ''} üíå`;
                    envelope.classList.remove('open');
                } else {
                    envelopeLabel.textContent = 'All read! ‚ú®';
                }
            }, 600);
        }

        window.closeLetterModal = function(event) {
            event.stopPropagation();
            const letterModal = document.getElementById('letterModal');
            letterModal.classList.remove('show');
        }

        // Custom cursor tracking
        const cursorFlower = document.getElementById('cursorFlower');
        const cursorLight = document.getElementById('cursorLight');
        let mouseX = 0;
        let mouseY = 0;
        let trailCounter = 0;

        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            
            cursorFlower.style.left = mouseX + 'px';
            cursorFlower.style.top = mouseY + 'px';
            cursorLight.style.left = mouseX + 'px';
            cursorLight.style.top = mouseY + 'px';
            
            trailCounter++;
            if (trailCounter % 3 === 0) {
                createTrailParticle(mouseX, mouseY);
            }
        });

        document.addEventListener('mousedown', () => {
            cursorFlower.classList.add('clicking');
        });

        document.addEventListener('mouseup', () => {
            cursorFlower.classList.remove('clicking');
        });

        function createTrailParticle(x, y) {
            const particle = document.createElement('div');
            particle.className = 'trail-particle';
            particle.style.left = x + 'px';
            particle.style.top = y + 'px';
            document.body.appendChild(particle);
            
            setTimeout(() => particle.remove(), 800);
        }

        function createPetal() {
            const petal = document.createElement('div');
            petal.className = 'petal';
            petal.style.left = Math.random() * 100 + 'vw';
            petal.style.animationDuration = (Math.random() * 3 + 4) + 's';
            petal.style.animationDelay = Math.random() * 2 + 's';
            document.body.appendChild(petal);
            setTimeout(() => petal.remove(), 8000);
        }

        setInterval(createPetal, 800);

        let noButtonClicks = 0;
        const messages = [
            "Wait! ü•∫",
            "Are you sure? üíî",
            "Think again! ‚ú®",
            "Really?? üò¢",
            "Please? üíù"
        ];

        // Simple slide pattern: right ‚Üí up ‚Üí left ‚Üí down ‚Üí repeat
        const slidePattern = [
            { x: '70%', y: '50%' },  // Right
            { x: '70%', y: '20%' },  // Up
            { x: '20%', y: '20%' },  // Left
            { x: '20%', y: '70%' },  // Down
            { x: '50%', y: '70%' },  // Bottom center
            { x: '80%', y: '70%' },  // Bottom right
            { x: '80%', y: '30%' },  // Right middle
            { x: '30%', y: '50%' }   // Left middle
        ];

        window.runAway = function() {
            const noBtn = document.getElementById('noBtn');
            const yesBtn = document.getElementById('yesBtn');
            
            noButtonClicks++;
            
            // Scale up Yes button
            const yesScale = 1 + (noButtonClicks * 0.2);
            yesBtn.style.transform = `scale(${yesScale})`;
            yesBtn.style.transition = 'transform 0.3s ease';
            
            // Scale down No button
            const noScale = Math.max(0.5, 1 - (noButtonClicks * 0.1));
            
            // Change text
            if (noButtonClicks <= messages.length) {
                noBtn.textContent = messages[noButtonClicks - 1];
            }
            
            // Get position from pattern (loop through pattern)
            const positionIndex = (noButtonClicks - 1) % slidePattern.length;
            const position = slidePattern[positionIndex];
            
            // Apply new position
            noBtn.style.position = 'fixed';
            noBtn.style.left = position.x;
            noBtn.style.top = position.y;
            noBtn.style.transform = `translate(-50%, -50%) scale(${noScale})`;
            noBtn.style.zIndex = '1000';
            noBtn.style.transition = 'all 0.3s ease';
        }

        window.sayYes = function() {
            const questionSection = document.getElementById('questionSection');
            const successSection = document.getElementById('successSection');
            const cursorFlower = document.getElementById('cursorFlower');
            const envelopeContainer = document.getElementById('envelopeContainer');
            
            cursorFlower.innerHTML = 'üíñ';
            
            envelopeContainer.classList.remove('peeking');
            envelopeContainer.classList.add('visible');
            
            questionSection.style.display = 'none';
            successSection.style.display = 'block';
            
            createConfetti();
            createHeartBurst();
        }

        function createConfetti() {
            const colors = ['#ff4d6d', '#ffd700', '#ff758f', '#ffccd5'];
            
            for (let i = 0; i < 80; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.style.position = 'fixed';
                    confetti.style.width = (Math.random() * 10 + 5) + 'px';
                    confetti.style.height = (Math.random() * 15 + 5) + 'px';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.top = '-50px';
                    confetti.style.borderRadius = '3px';
                    confetti.style.animation = `confettiFall ${Math.random() * 2 + 2}s linear forwards`;
                    confetti.style.pointerEvents = 'none';
                    confetti.style.zIndex = '99999';
                    
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 30);
            }
        }

        function createHeartBurst() {
            const hearts = ['üíñ', 'üíï', 'üíó', 'üíù'];
            
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const heart = document.createElement('div');
                    heart.innerHTML = hearts[Math.floor(Math.random() * hearts.length)];
                    heart.style.position = 'fixed';
                    heart.style.fontSize = (Math.random() * 30 + 20) + 'px';
                    heart.style.left = '50%';
                    heart.style.top = '50%';
                    heart.style.pointerEvents = 'none';
                    heart.style.animation = 'fireworkExplode 2s ease-out forwards';
                    heart.style.zIndex = '99999';
                    
                    const angle = (Math.PI * 2 * i) / 30;
                    const distance = Math.random() * 300 + 200;
                    heart.style.setProperty('--x', Math.cos(angle) * distance + 'px');
                    heart.style.setProperty('--y', Math.sin(angle) * distance + 'px');
                    
                    document.body.appendChild(heart);
                    setTimeout(() => heart.remove(), 2000);
                }, i * 40);
            }
        }

        for (let i = 0; i < 10; i++) {
            setTimeout(createPetal, i * 300);
        }

        const style = document.createElement('style');
        style.textContent = `
            @keyframes confettiFall {
                0% {
                    transform: translateY(0) rotate(0deg);
                    opacity: 1;
                }
                100% {
                    transform: translateY(100vh) rotate(${Math.random() * 720}deg);
                    opacity: 0;
                }
            }
            @keyframes fireworkExplode {
                0% {
                    transform: translate(0, 0);
                    opacity: 1;
                }
                100% {
                    transform: translate(var(--x), var(--y));
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>